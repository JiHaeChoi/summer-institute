name: Generate Site Scaffolds
on:
  workflow_dispatch:
    inputs:
      sites_data:
        description: 'CSV data for sites (header row: YEAR,NAME,other_fields...)'
        required: true
        type: string
      debug_mode:
        description: 'Enable debug output'
        type: boolean
        default: true
jobs:
  generate-scaffolds:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history needed to check previous years
        sparse-checkout: |
          /*
          !assets/
        sparse-checkout-cone-mode: false
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas
        
    - name: Debug Repository Structure
      if: inputs.debug_mode
      run: |
        echo "Current directory structure:"
        ls -R
        echo "Content of template directories:"
        ls -la .20XX_template || echo ".20XX_template not found"
        ls -la *data/.template || echo "*data/.template not found"
        
    - name: Create and Verify Input CSV
      run: |
        echo "Creating sites.csv with content:"
        echo "${{ github.event.inputs.sites_data }}" | tee sites.csv
        echo "Verifying CSV content:"
        cat sites.csv
        echo "CSV file size: $(wc -c < sites.csv) bytes"
        
    - name: Run scaffold generator
      run: python -v .github/scripts/generate_site_scaffolds.py
      env:
        DEBUG: ${{ inputs.debug_mode }}
      
    - name: Check for Changes
      id: check_changes
      run: |
        git status
        # Set output based on whether there are changes
        git diff --quiet && echo "changes_exist=false" >> $GITHUB_OUTPUT || echo "changes_exist=true" >> $GITHUB_OUTPUT
        
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes_exist == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .
        git status
        git commit -m "Generate site scaffolds from CSV" || echo "No changes to commit"
        git push
